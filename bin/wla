#!/bin/sh

#
# wla - WorkLog Archive（作業ログアーカイブ）
#
# 当日以前の作業ログを保管用フォルダにアーカイブ（移動）する
#
# Usage:
#   wla
#
# 1. junkフォルダへのパス取得
# 2. yyyy-mm-dd-journal.mdを対象
# 3. junkフォルダ内の worklog/yyyy/mm にコピーする
#

JOURNAL_FILE_NAME_PATTERN='[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]-journal.md'

if [ -z "$EMACS_HOME" ]; then
  echo Error: "EMACS_HOME" is not defind
  exit
fi

EMACS_HOME_CYG=`cygpath -u $EMACS_HOME`
VAR_FOLDER_PATH="$EMACS_HOME_CYG/var"
JUNK_FOLDER_PATH="$VAR_FOLDER_PATH/junk"
WORKLOG_FOLDER_PATH="$JUNK_FOLDER_PATH/worklog"

TODAY=`date -Idate`

for file in `find $JUNK_FOLDER_PATH/* -maxdepth 1 -type f -name "$JOURNAL_FILE_NAME_PATTERN"`; do
  BASENAME=`basename $file`

  # 当日分は対象外
  if [ `echo $BASENAME | grep $TODAY` ]; then
    continue
  fi

  YMD=( `echo $BASENAME | tr '-' ' '` )

  WORKLOG_DEST="$WORKLOG_FOLDER_PATH/${YMD[0]}/${YMD[1]}"

  # アーカイブ用年月フォルダ作成
  if [ ! -d $WORKLOG_DEST ]; then
    mkdir -p $WORKLOG_DEST
  fi

  echo move $WORKLOG_DEST/$BASENAME
  mv $file $WORKLOG_DEST
done
